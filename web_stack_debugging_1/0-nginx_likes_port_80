#!/usr/bin/env bash
# This script installs and configures Nginx to ensure it is running and listening on port 80

# Exit immediately if a command exits with a non-zero status
set -e

# Install Nginx if it is not already installed
if ! dpkg -l | grep -q nginx; then
    sudo apt-get update
    sudo apt-get install -y nginx
fi

# Ensure the default site configuration is present and correct
if ! grep -q "listen 80" /etc/nginx/sites-available/default; then
    sudo sed -i 's/listen 80 default_server;/listen 80 default_server;/g' /etc/nginx/sites-available/default
    sudo sed -i 's/listen \[::\]:80 default_server;/listen \[::\]:80 default_server;/g' /etc/nginx/sites-available/default
fi

# Check Nginx configuration for syntax errors
sudo nginx -t

# Restart Nginx to apply changes
sudo systemctl restart nginx

# Verify that Nginx is running and listening on port 80
if ! sudo netstat -tuln | grep ':80'; then
    echo "Error: Nginx is not listening on port 80"
    exit 1
fi

# Verify Nginx returns HTTP 200 on port 80
if ! curl -s -o /dev/null -w "%{http_code}" http://localhost | grep -q "200"; then
    echo "Error: Nginx did not return HTTP 200"
    exit 1
else
    echo "Nginx is successfully running and returning HTTP 200 on port 80"
fi

